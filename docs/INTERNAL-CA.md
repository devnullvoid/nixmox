# NixMox Internal CA Infrastructure

This document describes the internal Certificate Authority (CA) infrastructure used by NixMox for secure communication between services.

## Overview

NixMox uses an internal CA to generate and sign certificates for all internal services. This provides:
- Secure communication between services
- Consistent certificate management
- No external certificate dependencies
- Full control over the PKI infrastructure

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   CA Private    │    │   CA Public     │    │   Server        │
│     Key         │    │  Certificate    │    │ Certificates    │
│                 │    │                 │    │                 │
│ (Keep Secure!)  │    │ (Distribute to  │    │ (Generated by   │
│                 │    │  all hosts)     │    │  CA)            │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Certificate    │    │  NixOS Hosts    │    │  Containers     │
│  Generation     │    │  (Trust CA)     │    │  (Use CA)       │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Components

### 1. CA Generation Script (`scripts/generate-ca.sh`)
Generates the internal CA and server certificates:
- **CA Private Key**: `certs/nixmox-internal-ca.key` (keep secure!)
- **CA Certificate**: `certs/nixmox-internal-ca.crt` (distribute to all hosts)
- **Server Certificate**: `certs/caddy-server.crt` (for Caddy)
- **CA Bundle**: `certs/ca-bundle.crt` (for containers)

### 2. Shared CA Module (`nixos/modules/shared/internal-ca.nix`)
Distributes the CA certificate to all NixOS hosts:
- Adds CA to system trust store
- Creates shared certificate directory
- Copies CA certificate on activation

### 3. Caddy Integration
Caddy uses the internal CA to sign certificates for all services:
- Configured via `useInternalCa` option
- Points to generated CA certificate and key
- Automatically signs certificates for all domains

### 4. Container Integration
All containers trust the internal CA:
- Mount `/var/lib/shared-certs/internal-ca.crt`
- Use `SSL_CERT_FILE` and `REQUESTS_CA_BUNDLE` environment variables
- Consistent certificate trust across all services

## Usage

### Initial Setup

1. **Generate CA certificates:**
   ```bash
   ./scripts/generate-ca.sh
   ```

2. **Deploy to all hosts:**
   ```bash
   ./scripts/deploy-with-ca.sh all
   ```

3. **Deploy to specific hosts:**
   ```bash
   ./scripts/deploy-with-ca.sh vaultwarden nextcloud
   ```

### Adding New Services

1. **Import the shared CA module:**
   ```nix
   imports = [ ../../shared/internal-ca.nix ];
   ```

2. **Enable internal CA:**
   ```nix
   services.nixmox.internalCa = {
     enable = true;
     caCertPath = ../../../certs/nixmox-internal-ca.crt;
   };
   ```

3. **Mount CA in containers:**
   ```nix
   volumes = [
     "/var/lib/shared-certs/internal-ca.crt:/etc/ssl/certs/internal-ca.crt:ro"
   ];
   ```

## Configuration

### Caddy Configuration

```nix
services.nixmox.caddy = {
  enable = true;
  useInternalCa = true;
  caCertPath = ./certs/nixmox-internal-ca.crt;
  caKeyPath = ./certs/nixmox-internal-ca.key;
  caName = "NixMox Internal CA";
};
```

### Container Configuration

```nix
virtualisation.oci-containers.containers.myservice = {
  # ... other config ...
  volumes = [
    "/var/lib/shared-certs/internal-ca.crt:/etc/ssl/certs/internal-ca.crt:ro"
  ];
  environment = {
    SSL_CERT_FILE = "/etc/ssl/certs/internal-ca.crt";
    REQUESTS_CA_BUNDLE = "/etc/ssl/certs/internal-ca.crt";
  };
};
```

## Security Considerations

### CA Private Key
- **NEVER commit the CA private key to version control**
- Store securely and restrict access
- Consider using hardware security modules (HSM) in production
- Rotate CA key periodically

### Certificate Distribution
- CA certificate is distributed to all hosts via NixOS
- Private keys remain on the CA host only
- All hosts trust the same CA certificate

### Certificate Rotation
- Server certificates are valid for 1 year
- CA certificate is valid for 10 years
- Plan for certificate rotation procedures

## Troubleshooting

### Certificate Trust Issues
1. Verify CA certificate is properly distributed:
   ```bash
   ls -la /var/lib/shared-certs/
   ```

2. Check system trust store:
   ```bash
   openssl verify -CAfile /var/lib/shared-certs/internal-ca.crt /path/to/cert.crt
   ```

3. Verify container mounts:
   ```bash
   podman exec container ls -la /etc/ssl/certs/internal-ca.crt
   ```

### Caddy Certificate Issues
1. Check CA configuration:
   ```bash
   systemctl status caddy
   journalctl -u caddy -f
   ```

2. Verify certificate paths:
   ```bash
   ls -la /var/lib/shared-certs/
   ```

## Future Enhancements

### Step-CA Integration
Consider migrating to [Step-CA](https://github.com/smallstep/certificates) for:
- ACME protocol support
- Automated certificate management
- Advanced PKI features
- Better certificate lifecycle management

### Certificate Monitoring
Implement monitoring for:
- Certificate expiration
- CA health status
- Certificate usage metrics

### Automated Rotation
Set up automated processes for:
- Certificate renewal
- CA key rotation
- Certificate distribution

## Files

- `scripts/generate-ca.sh` - CA generation script
- `scripts/deploy-with-ca.sh` - Deployment script with CA support
- `nixos/modules/shared/internal-ca.nix` - Shared CA module
- `nixos/modules/caddy/default.nix` - Caddy integration
- `certs/` - Certificate directory (gitignored)
- `.gitignore` - Excludes certificate files

## References

- [OpenSSL Documentation](https://www.openssl.org/docs/)
- [Caddy PKI Configuration](https://caddyserver.com/docs/caddyfile/directives/pki)
- [NixOS Security Options](https://nixos.org/manual/nixos/stable/options.html#opt-security.pki.certificates)

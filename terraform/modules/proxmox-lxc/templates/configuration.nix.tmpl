# Minimal NixOS configuration for LXC container bootstrap
# This file is templated by Terraform and pushed to each container
# Based on: https://nixos.wiki/wiki/Proxmox_Linux_Container

{ config, modulesPath, pkgs, lib, ... }:

{
  imports = [ (modulesPath + "/virtualisation/proxmox-lxc.nix") ];
  
  nix.settings = { sandbox = false; };
  
  proxmoxLXC = {
    manageNetwork = false;
    privileged = false;
  };
  
  security.pam.services.sshd.allowNullPassword = true;
  
  services.openssh = {
    enable = true;
    openFirewall = true;
    settings = {
      PermitRootLogin = "yes";
      PasswordAuthentication = false;
      PermitEmptyPasswords = false;
    };
  };

  # SSH authorized keys
  users.users.root.openssh.authorizedKeys.keys = [
    "${ssh_authorized_key}"
  ];

  # Basic packages
  environment.systemPackages = with pkgs; [
    vim
    wget
    curl
    git
    htop
    tmux
  ];

  # Basic networking - explicitly configure static IP from Proxmox
  networking.useDHCP = false;
  networking.interfaces.eth0 = {
    useDHCP = false;
    ipv4.addresses = [
      {
        address = "${ip}";
        prefixLength = 24;
      }
    ];
    ipv4.routes = [
      {
        address = "0.0.0.0";
        prefixLength = 0;
        via = "${gw}";
      }
    ];
  };
  
  # DNS configuration
  networking.nameservers = [ "8.8.8.8" "1.1.1.1" ];

  # Time zone
  time.timeZone = "UTC";

  # Locale
  i18n.defaultLocale = "en_US.UTF-8";
  i18n.supportedLocales = [ "en_US.UTF-8/UTF-8" ];

  # Security settings
  security.sudo.wheelNeedsPassword = false;
  users.users.root.extraGroups = [ "wheel" ];

  # Enable flakes
  nix.settings.experimental-features = [ "nix-command" "flakes" ];

  # Allow unfree packages (needed for some proprietary software)
  nixpkgs.config.allowUnfree = true;

  system.stateVersion = "${nixos_version}";
  
  # Hostname
  networking.hostName = "${hostname}";
}
